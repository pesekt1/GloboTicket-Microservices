name: Manual Build and Package Sales Messages

on:
  workflow_dispatch:   # run manually only

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout
      uses: actions/checkout@v4

    # 2️⃣ Install NuGet
    - name: Install NuGet
      uses: NuGet/setup-nuget@v1

    # 3️⃣ Pack Messages project
    - name: Pack Messages Project
      run: |
        dotnet pack "Sales/GloboTicket.Sales.Messages/GloboTicket.Sales.Messages.csproj" --configuration Release --output ./nupkgs

    # 4️⃣ Upload NuGet artifact (optional)
    - name: Upload NuGet Artifact
      uses: actions/upload-artifact@v4
      with:
        name: drop
        path: ./nupkgs/*.nupkg

    # 5️⃣ Add Azure Artifacts source using PAT (PowerShell safe)
    - name: Add Azure Artifacts Source
      run: |
        nuget sources Add -Name "SalesFeed" `
          -Source "https://pkgs.dev.azure.com/TOMP0700/GloboTicket/_packaging/SalesFeed/nuget/v3/index.json" `
          -Username "any" `
          -Password "${{ secrets.AZURE_DEVOPS_PAT }}" `
          -StorePasswordInClearText

    # 6️⃣ Push NuGet package to Azure Artifacts
    - name: Push NuGet Packages
      run: |
        nuget push "./nupkgs/*.nupkg" `
          -Source "SalesFeed" `
          -SkipDuplicate `
          -ApiKey "not_needed"
