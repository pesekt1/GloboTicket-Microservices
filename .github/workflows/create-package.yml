name: Manual Build and Package Sales

on:
  workflow_dispatch:   # <-- Run manually only

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1️⃣ Checkout repo
    - name: Checkout
      uses: actions/checkout@v4

    # 2️⃣ Install NuGet
    - name: Install NuGet
      uses: NuGet/setup-nuget@v1

    # 3️⃣ Restore NuGet packages
    - name: Restore NuGet Packages
      run: nuget restore **/Sales.sln

    # 4️⃣ Setup MSBuild
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3

    # 5️⃣ Build solution
    - name: Build Solution
      run: |
        msbuild **/Sales.sln ^
          /p:Configuration=Release ^
          /p:Platform="Any CPU" ^
          /p:DeployOnBuild=true ^
          /p:WebPublishMethod=Package ^
          /p:PackageAsSingleFile=true ^
          /p:SkipInvalidConfigurations=true ^
          /p:PackageLocation="$(Build.ArtifactStagingDirectory)"

    # 6️⃣ Run tests
    - name: Run Tests
      uses: microsoft/vstest-action@v1
      with:
        testAssembly: '**\*test*.dll'

    # 7️⃣ Pack Messages project
    - name: Pack Messages Project
      run: |
        dotnet pack "Sales/**/*.Messages.csproj" --no-build --configuration Release

    # 8️⃣ Upload NuGet artifacts
    - name: Upload NuGet Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: drop
        path: "**/*.nupkg"

    # 9️⃣ Add Azure Artifacts source using PAT
    - name: Add Azure Artifacts Source
      run: |
        nuget sources Add ^
          -Name "SalesFeed" ^
          -Source "https://pkgs.dev.azure.com/TOMP0700/GloboTicket/_packaging/SalesFeed/nuget/v3/index.json" ^
          -Username "any" ^
          -Password "${{ secrets.AZURE_DEVOPS_PAT }}" ^
          -StorePasswordInClearText

    # 🔟 Push NuGet packages
    - name: Push NuGet Packages
      run: |
        nuget push "**/*.nupkg" ^
          -Source "SalesFeed" ^
          -SkipDuplicate ^
          -ApiKey "not_needed"
